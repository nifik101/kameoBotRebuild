<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Async Process Demo</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f7f7fa;
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
      margin: 0;
    }
    .card {
      background: #fff;
      padding: 24px 32px;
      border-radius: 8px;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
      text-align: center;
      width: 360px;
    }
    button {
      background: #0059c1;
      border: none;
      color: #fff;
      padding: 12px 24px;
      font-size: 1rem;
      border-radius: 4px;
      cursor: pointer;
      transition: opacity 0.2s;
    }
    button:disabled {
      cursor: not-allowed;
      opacity: 0.65;
    }
    .spinner {
      margin: 16px auto;
      width: 40px;
      height: 40px;
      border: 4px solid #ccc;
      border-top: 4px solid #0059c1;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }
    .result {
      margin-top: 16px;
      text-align: left;
      max-height: 240px;
      overflow: auto;
      background: #f3f5f9;
      padding: 12px;
      border-radius: 4px;
      font-size: 0.9rem;
      white-space: pre-wrap;
    }
  </style>
  <!-- React & Zustand via CDN -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script crossorigin src="https://unpkg.com/zustand/umd/zustand.min.js"></script>
</head>
<body>
  <div id="root"></div>
  <script type="text/javascript">
    const { useEffect, useState } = React;
    const create = window.zustand.create;

    // Zustand store
    const useJobStore = create((set) => ({
      jobId: null,
      status: "idle", // idle | pending | success | failed | timeout
      result: null,
      error: null,
      startTime: null,
      setJob: (data) => set(data),
      reset: () => set({ jobId: null, status: "idle", result: null, error: null, startTime: null }),
    }));

    function Spinner() {
      return <div className="spinner" />;
    }

    function App() {
      const { jobId, status, result, error, startTime, setJob, reset } = useJobStore();
      const [pollInterval, setPollInterval] = useState(null);
      
      const TIMEOUT_MS = 5 * 60 * 1000; // 5 minutes timeout
      const POLL_INTERVAL_MS = 2000; // Poll every 2 seconds

      const startJob = async () => {
        try {
          reset();
          setJob({ status: "pending", error: null, result: null, startTime: Date.now() });
          
          const res = await fetch("http://localhost:8000/api/jobs/fetch-loans", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
          });
          
          if (!res.ok) {
            const errorData = await res.json();
            throw new Error(errorData.detail || `HTTP ${res.status}`);
          }
          
          const data = await res.json();
          if (data.status === "pending") {
            setJob({ jobId: data.data.job_id, status: "pending" });
          } else {
            setJob({ status: "failed", error: "Unexpected response format" });
          }
        } catch (e) {
          console.error("Failed to start job:", e);
          setJob({ status: "failed", error: e.message || "Nätverksfel vid start av jobb" });
        }
      };

      // Enhanced polling effect with timeout
      useEffect(() => {
        if (status === "pending" && jobId && startTime) {
          const id = setInterval(async () => {
            // Check for timeout
            if (Date.now() - startTime > TIMEOUT_MS) {
              setJob({ status: "failed", error: "Timeout - processen tog för lång tid (>5 min)" });
              clearInterval(id);
              return;
            }
            
            try {
              const res = await fetch(`http://localhost:8000/api/jobs/${jobId}`);
              
              if (!res.ok) {
                if (res.status === 404) {
                  setJob({ status: "failed", error: "Jobbet hittades inte (kanske rensades bort)" });
                } else {
                  const errorData = await res.json();
                  setJob({ status: "failed", error: errorData.detail || `HTTP ${res.status}` });
                }
                clearInterval(id);
                return;
              }
              
              const data = await res.json();
              
              if (data.status === "success") {
                setJob({ status: "success", result: data.data });
                clearInterval(id);
              } else if (data.status === "failed") {
                setJob({ status: "failed", error: data.error || "Okänt fel från servern" });
                clearInterval(id);
              }
              // If still pending, continue polling
              
            } catch (e) {
              console.error("Polling error:", e);
              setJob({ status: "failed", error: e.message || "Nätverksfel vid polling" });
              clearInterval(id);
            }
          }, POLL_INTERVAL_MS);
          
          setPollInterval(id);
          
          return () => {
            clearInterval(id);
            setPollInterval(null);
          };
        }
      }, [status, jobId, startTime]);

      // Cleanup interval on unmount
      useEffect(() => {
        return () => {
          if (pollInterval) {
            clearInterval(pollInterval);
          }
        };
      }, [pollInterval]);

      const formatElapsedTime = () => {
        if (!startTime) return "";
        const elapsed = Math.floor((Date.now() - startTime) / 1000);
        return `(${elapsed}s)`;
      };

      const formatResult = (result) => {
        if (!result) return "Inget resultat";
        
        if (result.loans && Array.isArray(result.loans)) {
          return `Hittade ${result.loans.length} lån:\n\n${JSON.stringify(result.loans, null, 2)}`;
        }
        
        return JSON.stringify(result, null, 2);
      };

      return (
        <div className="card">
          <h2>Hämta lån asynkront</h2>
          <button onClick={startJob} disabled={status === "pending"}>
            {status === "pending" ? `Arbetar... ${formatElapsedTime()}` : "Starta"}
          </button>

          {status === "pending" && (
            <div>
              <Spinner />
              <p style={{ fontSize: "0.9rem", color: "#666", marginTop: "8px" }}>
                Hämtar data från Kameo... {formatElapsedTime()}
              </p>
            </div>
          )}

          {status === "success" && (
            <div>
              <p style={{ color: "green", fontWeight: "bold" }}>✅ Framgång!</p>
              <div className="result">
                {formatResult(result)}
              </div>
              <button onClick={reset} style={{ marginTop: "16px", background: "#28a745" }}>
                Kör igen
              </button>
            </div>
          )}

          {status === "failed" && (
            <div>
              <p style={{ color: "red", fontWeight: "bold" }}>❌ Fel uppstod:</p>
              <p style={{ color: "red", fontSize: "0.9rem" }}>{error}</p>
              <button onClick={reset} style={{ marginTop: "16px", background: "#dc3545" }}>
                Försök igen
              </button>
            </div>
          )}

          {status === "idle" && (
            <p style={{ color: "#666", fontSize: "0.9rem", marginTop: "16px" }}>
              Klicka på "Starta" för att hämta lån från Kameo API
            </p>
          )}
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<App />);
  </script>
</body>
</html> 