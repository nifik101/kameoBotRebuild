<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Async Process Demo</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f7f7fa;
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
      margin: 0;
    }
    .card {
      background: #fff;
      padding: 24px 32px;
      border-radius: 8px;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
      text-align: center;
      width: 360px;
    }
    button {
      background: #0059c1;
      border: none;
      color: #fff;
      padding: 12px 24px;
      font-size: 1rem;
      border-radius: 4px;
      cursor: pointer;
      transition: opacity 0.2s;
    }
    button:disabled {
      cursor: not-allowed;
      opacity: 0.65;
    }
    .spinner {
      margin: 16px auto;
      width: 40px;
      height: 40px;
      border: 4px solid #ccc;
      border-top: 4px solid #0059c1;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }
    .result {
      margin-top: 16px;
      text-align: left;
      max-height: 240px;
      overflow: auto;
      background: #f3f5f9;
      padding: 12px;
      border-radius: 4px;
      font-size: 0.9rem;
      white-space: pre-wrap;
    }
  </style>
  <!-- React & Zustand via CDN -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script crossorigin src="https://unpkg.com/zustand/umd/zustand.min.js"></script>
</head>
<body>
  <div id="root"></div>
  <script type="text/javascript">
    const { useEffect, useState } = React;
    const create = window.zustand.create;

    // Zustand store
    const useJobStore = create((set) => ({
      jobId: null,
      status: "idle", // idle | pending | success | failed
      result: null,
      error: null,
      setJob: (data) => set(data),
    }));

    function Spinner() {
      return <div className="spinner" />;
    }

    function App() {
      const { jobId, status, result, error, setJob } = useJobStore();
      const [pollInterval, setPollInterval] = useState(null);

      const startJob = async () => {
        try {
          setJob({ status: "pending", error: null, result: null });
          const res = await fetch("http://localhost:8000/api/jobs/fetch-loans", {
            method: "POST",
          });
          const data = await res.json();
          if (data.status === "pending") {
            setJob({ jobId: data.data.job_id, status: "pending" });
          } else {
            setJob({ status: "failed", error: "Unexpected response" });
          }
        } catch (e) {
          setJob({ status: "failed", error: e.message || "N채tverksfel" });
        }
      };

      // Polling effect
      useEffect(() => {
        if (status === "pending" && jobId) {
          const id = setInterval(async () => {
            try {
              const res = await fetch(
                `http://localhost:8000/api/jobs/${jobId}`
              );
              const data = await res.json();
              if (data.status === "success") {
                setJob({ status: "success", result: data.data });
                clearInterval(id);
              } else if (data.status === "failed") {
                setJob({ status: "failed", error: data.error || "Fel" });
                clearInterval(id);
              }
            } catch (e) {
              setJob({ status: "failed", error: e.message || "N채tverksfel" });
              clearInterval(id);
            }
          }, 2000);
          setPollInterval(id);
          return () => clearInterval(id);
        }
      }, [status, jobId]);

      return (
        <div className="card">
          <h2>H채mta l책n asynkront</h2>
          <button onClick={startJob} disabled={status === "pending"}>
            {status === "pending" ? "Arbetar..." : "Starta"}
          </button>

          {status === "pending" && <Spinner />}

          {status === "success" && (
            <div className="result">
              {JSON.stringify(result, null, 2)}
            </div>
          )}

          {status === "failed" && (
            <p style={{ color: "red" }}>Fel: {error}</p>
          )}
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<App />);
  </script>
</body>
</html> 